<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Playwright Metrics Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <style>
      :root {
        font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        color-scheme: dark;

        --bg-0: #050816;
        --bg-1: #070b1d;
        --bg-2: #0b1028;

        --card: rgba(12, 18, 45, 0.72);
        --card-strong: rgba(16, 24, 58, 0.8);

        --border: rgba(148, 163, 184, 0.16);
        --border-strong: rgba(148, 163, 184, 0.26);

        --text: #e8eefc;
        --muted: rgba(226, 232, 240, 0.72);
        --soft: rgba(226, 232, 240, 0.52);

        --accent: #5eead4;
        --accent-2: #60a5fa;

        --ok: #34d399;
        --warn: #fbbf24;
        --bad: #fb7185;

        --radius-lg: 20px;
        --radius-md: 14px;
        --radius-pill: 999px;

        --shadow: 0 18px 50px rgba(0, 0, 0, 0.35);
        --shadow-soft: 0 12px 30px rgba(0, 0, 0, 0.25);
      }

      * { box-sizing: border-box; }

      body {
        margin: 0;
        min-height: 100vh;
        color: var(--text);
        background:
          radial-gradient(900px 420px at 15% 10%, rgba(96, 165, 250, 0.20), transparent 60%),
          radial-gradient(800px 380px at 85% 12%, rgba(94, 234, 212, 0.16), transparent 60%),
          radial-gradient(900px 520px at 50% 95%, rgba(244, 114, 182, 0.10), transparent 65%),
          linear-gradient(180deg, var(--bg-2), var(--bg-0));
      }

      .page {
        max-width: 1100px;
        margin: 0 auto;
        padding: 28px 18px 56px;
      }

      .header {
        display: flex;
        align-items: flex-end;
        justify-content: space-between;
        gap: 14px;
        margin-bottom: 18px;
      }

      .title h1 {
        margin: 0;
        font-size: clamp(1.55rem, 2.2vw, 2.0rem);
        letter-spacing: 0.02em;
      }

      .title p {
        margin: 6px 0 0;
        color: var(--soft);
        font-size: 0.95rem;
      }

      .source {
        display: inline-flex;
        align-items: center;
        gap: 10px;
        padding: 9px 12px;
        border-radius: var(--radius-pill);
        border: 1px solid var(--border);
        background: rgba(10, 14, 34, 0.55);
        box-shadow: var(--shadow-soft);
        color: var(--muted);
        font-size: 0.82rem;
        white-space: nowrap;
      }

      .source .dot {
        width: 9px;
        height: 9px;
        border-radius: 999px;
        background: radial-gradient(circle at 30% 30%, var(--accent), rgba(94,234,212,0.35));
        box-shadow: 0 0 14px rgba(94, 234, 212, 0.55);
      }

      code {
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
        font-size: 0.92em;
      }

      .summary {
        display: grid;
        grid-template-columns: repeat(3, minmax(0, 1fr));
        gap: 12px;
        margin: 16px 0 22px;
      }

      .summary-card {
        border-radius: var(--radius-lg);
        border: 1px solid var(--border);
        background: linear-gradient(180deg, rgba(16, 24, 58, 0.68), rgba(8, 12, 30, 0.62));
        box-shadow: var(--shadow);
        padding: 14px 14px 13px;
        position: relative;
        overflow: hidden;
      }

      .summary-card::before {
        content: "";
        position: absolute;
        inset: 0;
        background:
          radial-gradient(600px 200px at 10% 10%, rgba(96, 165, 250, 0.18), transparent 55%),
          radial-gradient(600px 220px at 90% 0%, rgba(94, 234, 212, 0.12), transparent 55%);
        opacity: 0.95;
        pointer-events: none;
      }

      .summary-card > * { position: relative; z-index: 1; }

      .kicker {
        font-size: 0.75rem;
        letter-spacing: 0.12em;
        text-transform: uppercase;
        color: var(--soft);
        margin-bottom: 6px;
      }

      .big {
        font-size: 1.45rem;
        font-weight: 700;
        letter-spacing: 0.01em;
        font-variant-numeric: tabular-nums;
      }

      .sub {
        margin-top: 6px;
        font-size: 0.86rem;
        color: var(--muted);
      }

      .pill {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 6px 10px;
        border-radius: var(--radius-pill);
        border: 1px solid var(--border-strong);
        background: rgba(5, 8, 22, 0.45);
        margin-top: 10px;
        font-size: 0.78rem;
        color: var(--muted);
      }

      .env-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(290px, 1fr));
        gap: 14px;
      }

      .env-card {
        border-radius: var(--radius-lg);
        border: 1px solid var(--border);
        background: linear-gradient(180deg, rgba(16, 24, 58, 0.62), rgba(8, 12, 30, 0.62));
        box-shadow: var(--shadow);
        padding: 14px;
        position: relative;
        overflow: hidden;
      }

      .env-card::before {
        content: "";
        position: absolute;
        inset: 0;
        background:
          radial-gradient(520px 220px at 18% 8%, rgba(96, 165, 250, 0.16), transparent 55%),
          radial-gradient(520px 240px at 88% 0%, rgba(94, 234, 212, 0.10), transparent 55%);
        opacity: 0.95;
        pointer-events: none;
      }

      .env-card > * { position: relative; z-index: 1; }

      .env-head {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
        margin-bottom: 10px;
      }

      .env-name {
        font-size: 0.92rem;
        font-weight: 700;
        letter-spacing: 0.14em;
        text-transform: uppercase;
      }

      .badge {
        padding: 6px 10px;
        border-radius: var(--radius-pill);
        font-size: 0.78rem;
        border: 1px solid var(--border-strong);
        background: rgba(5, 8, 22, 0.5);
        color: var(--muted);
        font-variant-numeric: tabular-nums;
        white-space: nowrap;
      }

      .badge.ok {
        border-color: rgba(52, 211, 153, 0.5);
        color: rgba(167, 243, 208, 0.95);
        box-shadow: 0 0 0 1px rgba(52, 211, 153, 0.12) inset;
      }

      .badge.warn {
        border-color: rgba(251, 191, 36, 0.5);
        color: rgba(254, 243, 199, 0.95);
        box-shadow: 0 0 0 1px rgba(251, 191, 36, 0.12) inset;
      }

      .badge.bad {
        border-color: rgba(251, 113, 133, 0.5);
        color: rgba(254, 205, 211, 0.95);
        box-shadow: 0 0 0 1px rgba(251, 113, 133, 0.12) inset;
      }

      .stats {
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 8px 12px;
        margin: 12px 0 10px;
        padding: 10px;
        border-radius: var(--radius-md);
        border: 1px solid var(--border);
        background: rgba(5, 8, 22, 0.38);
      }

      .stat {
        display: flex;
        justify-content: space-between;
        gap: 10px;
        font-size: 0.84rem;
      }

      .stat .k { color: var(--soft); }
      .stat .v { font-weight: 600; font-variant-numeric: tabular-nums; }

      .meta {
        font-size: 0.78rem;
        color: var(--soft);
        line-height: 1.45;
      }

      .links {
        margin-top: 12px;
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
      }

      .link {
        text-decoration: none;
        color: rgba(224, 242, 254, 0.95);
        font-size: 0.82rem;
        padding: 8px 11px;
        border-radius: var(--radius-pill);
        border: 1px solid rgba(96, 165, 250, 0.35);
        background: rgba(96, 165, 250, 0.10);
        transition: transform 120ms ease, border-color 120ms ease, background 120ms ease;
      }

      .link:hover {
        transform: translateY(-1px);
        border-color: rgba(96, 165, 250, 0.65);
        background: rgba(96, 165, 250, 0.16);
      }

      .loading, .error, .empty {
        margin-top: 28px;
        color: var(--muted);
      }

      .error { color: rgba(251, 113, 133, 0.95); }

      @media (max-width: 760px) {
        .header { align-items: flex-start; flex-direction: column; }
        .summary { grid-template-columns: 1fr; }
        .source { width: 100%; justify-content: space-between; }
      }
    </style>
  </head>

  <body>
    <div class="page">
      <div class="header">
        <div class="title">
          <h1>Playwright Metrics</h1>
          <p>Latest run per environment (totals + optional categories)</p>
        </div>

        <div class="source">
          <span class="dot"></span>
          <span>Source: <code>site/metrics-latest.json</code></span>
        </div>
      </div>

      <main id="app">
        <p class="loading">Loading metrics…</p>
      </main>
    </div>

    <script>
      function toNumber(v) {
        const n = Number(v);
        return Number.isFinite(n) ? n : 0;
      }

      function badgeClass(passRate) {
        if (!Number.isFinite(passRate)) return "badge";
        if (passRate >= 95) return "badge ok";
        if (passRate >= 85) return "badge warn";
        return "badge bad";
      }

      async function loadMetrics() {
        const app = document.getElementById("app");

        try {
          const res = await fetch("metrics-latest.json", { cache: "no-store" });
          if (!res.ok) throw new Error("HTTP " + res.status);

          const data = await res.json();
          const envNames = Object.keys(data || {}).sort();

          if (!envNames.length) {
            app.innerHTML = '<p class="empty">No metrics available yet.</p>';
            return;
          }

          // global totals
          let totalAll = 0;
          let totalPassed = 0;

          envNames.forEach((env) => {
            const t = data[env]?.totals || {};
            totalAll += toNumber(t.all);
            totalPassed += toNumber(t.passed);
          });

          const overallPassRate =
            totalAll === 0 ? 0 : Math.round((totalPassed / totalAll) * 100);

          // Summary section
          const summary = document.createElement("section");
          summary.className = "summary";
          summary.innerHTML = `
            <article class="summary-card">
              <div class="kicker">Overall pass rate</div>
              <div class="big">${overallPassRate}%</div>
              <div class="sub">Across all environments</div>
              <div class="pill">Passed: <strong>${totalPassed}</strong> / ${totalAll}</div>
            </article>

            <article class="summary-card">
              <div class="kicker">Total tests</div>
              <div class="big">${totalAll}</div>
              <div class="sub">Sum of totals for each environment</div>
            </article>

            <article class="summary-card">
              <div class="kicker">Passed</div>
              <div class="big">${totalPassed}</div>
              <div class="sub">Global passed count</div>
            </article>
          `;

          // Environment cards
          const grid = document.createElement("section");
          grid.className = "env-grid";

          envNames.forEach((envName) => {
            const m = data[envName] || {};
            const t = m.totals || {};
            const passRate = Number.isFinite(m.passRate) ? m.passRate : 0;

            const showSecurity = t.security !== undefined;
            const showFunctional = t.functional !== undefined;

            const runTime = m.timestampISO ? new Date(m.timestampISO).toLocaleString() : "n/a";

            const card = document.createElement("article");
            card.className = "env-card";
            card.innerHTML = `
              <div class="env-head">
                <div class="env-name">${(m.env || envName).toString()}</div>
                <div class="${badgeClass(passRate)}">${passRate}% pass</div>
              </div>

              <div class="stats">
                <div class="stat"><span class="k">Total</span><span class="v">${t.all ?? "–"}</span></div>
                <div class="stat"><span class="k">Passed</span><span class="v">${t.passed ?? "–"}</span></div>
                <div class="stat"><span class="k">Failed</span><span class="v">${t.failed ?? "–"}</span></div>
                <div class="stat"><span class="k">Skipped</span><span class="v">${t.skipped ?? "–"}</span></div>
                ${
                  showSecurity
                    ? `<div class="stat"><span class="k">Security</span><span class="v">${t.security}</span></div>`
                    : ""
                }
                ${
                  showFunctional
                    ? `<div class="stat"><span class="k">Functional</span><span class="v">${t.functional}</span></div>`
                    : ""
                }
              </div>

              <div class="meta">
                Run ID: ${m.runId || "n/a"}<br />
                SHA: ${m.gitSha || "n/a"}<br />
                Time: ${runTime}
              </div>

              <div class="links">
                ${
                  m.reportUrl
                    ? `<a class="link" href="${m.reportUrl}" target="_blank" rel="noopener noreferrer">Open report</a>`
                    : ""
                }
              </div>
            `;

            grid.appendChild(card);
          });

          app.innerHTML = "";
          app.appendChild(summary);
          app.appendChild(grid);
        } catch (err) {
          console.error(err);
          app.innerHTML =
            '<p class="error">Failed to load metrics. Check that <code>metrics-latest.json</code> exists and is reachable.</p>';
        }
      }

      loadMetrics();
    </script>
  </body>
</html>
